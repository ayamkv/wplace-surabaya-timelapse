name: Upload to Telegram with Local Bot API

on:
  workflow_dispatch:
    inputs:
      date:
        description: 'Date in YYYYMMDD format'
        required: true
        type: string
      message:
        description: 'Optional message'
        required: false
        type: string
        default: ''

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip

      - name: Cache Telegram Bot API server
        id: cache-bot-api
        uses: actions/cache@v4
        with:
          path: telegram-bot-api
          key: telegram-bot-api-${{ runner.os }}-latest
          restore-keys: |
            telegram-bot-api-${{ runner.os }}-

      - name: Download and setup Telegram Bot API server
        if: steps.cache-bot-api.outputs.cache-hit != 'true'
        run: |
          # –°–∫–∞—á–∏–≤–∞–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π Bot API —Å–µ—Ä–≤–µ—Ä
          wget https://github.com/tdlib/telegram-bot-api/releases/latest/download/telegram-bot-api-linux.zip
          unzip telegram-bot-api-linux.zip
          rm telegram-bot-api-linux.zip

      - name: Setup Bot API server
        run: |
          chmod +x telegram-bot-api
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
          mkdir -p bot-data

      - name: Start local Bot API server
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
          ./telegram-bot-api --api-id=${{ secrets.TELEGRAM_API_ID }} \
                            --api-hash=${{ secrets.TELEGRAM_API_HASH }} \
                            --local \
                            --dir=./bot-data \
                            --temp-dir=./bot-data/temp \
                            --http-port=8081 &
          
          # –ñ–¥–µ–º –ø–æ–∫–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
          curl -f http://localhost:8081/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getMe || exit 1

      - name: Check if timelapse exists
        id: check
        run: |
          if [ -f "timelapse/timelapse_${{ github.event.inputs.date }}.mp4" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "file_size=$(stat -f%z timelapse/timelapse_${{ github.event.inputs.date }}.mp4 2>/dev/null || stat -c%s timelapse/timelapse_${{ github.event.inputs.date }}.mp4)" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload to Telegram
        if: steps.check.outputs.exists == 'true'
        run: |
          VIDEO_FILE="timelapse/timelapse_${{ github.event.inputs.date }}.mp4"
          FILE_SIZE="${{ steps.check.outputs.file_size }}"
          
          # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
          FORMATTED_DATE=$(echo "${{ github.event.inputs.date }}" | sed 's/\(.\{4\}\)\(.\{2\}\)\(.\{2\}\)/\1-\2-\3/')
          
          # –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="ü§ñ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ç–∞–π–º–ª–∞–ø—Å –∑–∞ ${FORMATTED_DATE}\n\n
            [üé¨ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã–º–∏ —Ç–∞–π–º–ª–∞–ø—Å–∞–º–∏](https://github.com/niklinque/wplace-tomsk-timelapse/)
            [üì∏ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –¥–∞–º–ø–∞–º–∏](https://github.com/niklinque/wplace-tomsk/)"
          if [ -n "${{ github.event.inputs.message }}" ]; then
            MESSAGE="${MESSAGE}\n\n${{ github.event.inputs.message }}"
          fi
          MESSAGE="${MESSAGE}\n\nüìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(numfmt --to=iec ${FILE_SIZE})"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π API (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–∞–π–ª—ã –¥–æ 2GB)
          curl -X POST "http://localhost:8081/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendVideo" \
               -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
               -F "video=@${VIDEO_FILE}" \
               -F "caption=${MESSAGE}" \
               -F "parse_mode=MARKDOWN" \
               -F "supports_streaming=true" \
               --max-time 1800 \
               --retry 3 \
               --retry-delay 30
