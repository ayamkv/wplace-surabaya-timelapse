name: Weekly Timelapse Release

on:
  schedule:
    - cron: '30 00 * * MON'  # Every Monday 00:30 UTC (~07:30 WIB)
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  weekly:
    runs-on: ubuntu-latest
    env:
      CRF: '18'
      PRESET: 'slow'
      PIX_FMT: 'yuv420p'
      DOWNSCALE_FACTOR: '2'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install -r requirements.txt
          ffmpeg -version || sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Generate last 7 days
        id: gen
        shell: bash
        run: |
          set -e
          . .venv/bin/activate
          rm -f list.txt weekly_files.txt
          # Build timelapse for each of the previous 7 days (1=Yesterday .. 7 days ago) using UTC+7 offset
          for i in $(seq 1 7); do
            DATE=$(date -u -d "$i day ago +7 hours" +%Y%m%d)
            echo "Building $DATE"
            python create_timelapse.py --date "$DATE" || true
          done
          # Collect last 7 mp4s (sorted)
            ls timelapse/timelapse_*.mp4 2>/dev/null | sort | tail -n 7 > weekly_files.txt || true
          if [ ! -s weekly_files.txt ]; then
            echo "No timelapse files"; exit 0; fi
          > list.txt
          while read -r F; do echo "file '$F'" >> list.txt; done < weekly_files.txt
          if [ -s list.txt ]; then
            ffmpeg -y -f concat -safe 0 -i list.txt -c copy timelapse/weekly_concat.mp4 \
              || ffmpeg -y -f concat -safe 0 -i list.txt -c:v libx264 -crf ${CRF} -preset ${PRESET} -pix_fmt ${PIX_FMT} timelapse/weekly_concat.mp4
          fi
          if [ -f timelapse/weekly_concat.mp4 ]; then echo "made=1" >> $GITHUB_OUTPUT; else echo "made=0" >> $GITHUB_OUTPUT; fi

      - name: Create weekly release
        if: steps.gen.outputs.made == '1'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: weekly-${{ github.run_number }}
          name: Weekly Timelapse (Run ${{ github.run_number }})
          files: |
            timelapse/weekly_concat.mp4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
